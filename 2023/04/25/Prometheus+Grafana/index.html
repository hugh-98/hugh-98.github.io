<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Prometheus+Grafana监控入门 | Hugh的个人博客</title><meta name="author" content="Hugh"><meta name="copyright" content="Hugh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考尚硅谷B站视频 本次课程涉及的组件主要有：  Prometheus：作为指标采集工具 Grafana：用于可视化收集的数据 睿象云：作为告警平台（不讲）   Prometheus介绍 Prometheus官网地址：https:&#x2F;&#x2F;prometheus.io&#x2F; 什么是Prometheus  官网介绍如下： Prometheus is an open-source systems monitori">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus+Grafana监控入门">
<meta property="og:url" content="https://hugh-98.github.io/2023/04/25/Prometheus+Grafana/index.html">
<meta property="og:site_name" content="Hugh的个人博客">
<meta property="og:description" content="参考尚硅谷B站视频 本次课程涉及的组件主要有：  Prometheus：作为指标采集工具 Grafana：用于可视化收集的数据 睿象云：作为告警平台（不讲）   Prometheus介绍 Prometheus官网地址：https:&#x2F;&#x2F;prometheus.io&#x2F; 什么是Prometheus  官网介绍如下： Prometheus is an open-source systems monitori">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hugh-98.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2023-04-25T02:47:23.000Z">
<meta property="article:modified_time" content="2023-05-02T12:31:46.601Z">
<meta property="article:author" content="Hugh">
<meta property="article:tag" content="Prometheus">
<meta property="article:tag" content="Grafana">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hugh-98.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hugh-98.github.io/2023/04/25/Prometheus+Grafana/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?75e27ce1a302654cd332f061e9a5e29b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Hugh","link":"链接: ","source":"来源: Hugh的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Prometheus+Grafana监控入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-02 20:31:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/default.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Hugh的个人博客"><span class="site-name">Hugh的个人博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Prometheus+Grafana监控入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-25T02:47:23.000Z" title="发表于 2023-04-25 10:47:23">2023-04-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-02T12:31:46.601Z" title="更新于 2023-05-02 20:31:46">2023-05-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9B%91%E6%8E%A7%E5%9F%9F/">监控域</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9B%91%E6%8E%A7%E5%9F%9F/Prometheus/">Prometheus</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>26分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Prometheus+Grafana监控入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>参考尚硅谷<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1HT4y1Z7vR">B站视频</a></p>
<p>本次课程涉及的组件主要有：</p>
<ul>
<li>Prometheus：作为指标采集工具</li>
<li>Grafana：用于可视化收集的数据</li>
<li>睿象云：作为告警平台（不讲）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030795.png" alt="image-20230425104104045"></p>
<h2 id="Prometheus介绍">Prometheus介绍</h2>
<p>Prometheus官网地址：<a target="_blank" rel="noopener" href="https://prometheus.io/">https://prometheus.io/</a></p>
<h3 id="什么是Prometheus">什么是Prometheus</h3>
<blockquote>
<p>官网介绍如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prometheus">Prometheus</a> is an open-source systems monitoring and alerting toolkit originally built at <a target="_blank" rel="noopener" href="https://soundcloud.com/">SoundCloud</a>. Since its inception in 2012, many companies and organizations have adopted Prometheus, and the project has a very active developer and user <a target="_blank" rel="noopener" href="https://prometheus.io/community">community</a>. It is now a standalone open source project and maintained independently of any company. To emphasize this, and to clarify the project’s governance structure, Prometheus joined the <a target="_blank" rel="noopener" href="https://cncf.io/">Cloud Native Computing Foundation</a> in 2016 as the second hosted project, after <a target="_blank" rel="noopener" href="http://kubernetes.io/">Kubernetes</a>.</p>
<p>Prometheus collects and stores its metrics as time series data, i.e. metrics information is stored with the timestamp at which it was recorded, alongside optional key-value pairs called labels.</p>
</blockquote>
<ul>
<li>Prometheus是一个开源的系统监控和告警工具包，于2012年开始研发，2015年发布早期版本</li>
<li>Prometheus是一个独立的开源项目，独立于任何公司进行维护。于2016年加入云原生计算基金会，成为继Kubernetes之后的第二个托管项目</li>
<li>Prometheus以时间序列数据的形式收集并存储指标，即指标信息与记录的时间戳一起存储，并可选key-value键值对作为标签。</li>
</ul>
<h3 id="特点">特点</h3>
<p>Prometheus是一个开源的完整监控解决方案，其对传统监控系统的测试和告警模型进行了彻底的颠覆，形成了基于<strong>中央化</strong>的规则计算、同意分析和告警的新模型。相比于传统监控系统，Prometheus具有以下优点：</p>
<h4 id="易于管理">易于管理</h4>
<ul>
<li>Prometheus核心部分只有一个单独的<strong>二进制文件</strong>，不存在任何的第三方依赖（数据库、缓存等）。唯一需要的就是本地磁盘，因此不会有潜在级联故障的风险。</li>
<li>Prometheus<strong>基于<code>pull</code>模型</strong>的架构方式，可以在任何地方（本地电脑、开发环境、测试环境）搭建我们的监控系统。</li>
<li>对于一些复杂的情况，还可以使用**Prometheus服务发现（Service Discovery）**的能力动态管理监控目标。</li>
</ul>
<h4 id="监控服务的内部运行状态">监控服务的内部运行状态</h4>
<p>Prometheus鼓励用户监控服务的内部状态，基于Prometheus丰富的Client库，用户可以轻松的在应用程序中添加对Prometheus的支持，从而让用户可以获取服务和应用内部真正的运行状态。</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030796.png" alt="image-20230426094643955"></p>
<h4 id="强大的数据模型">强大的数据模型</h4>
<p>所有采集的监控数据均以指标（metric）的形式保存在**内置的时间序列数据库（TSDB）**中。所有的样本除了基本的指标名称以外，还包含一组用于描述该样本特征的标签。</p>
<p>标签样式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">http_request_status&#123;</span><br><span class="line">    code=&#x27;200&#x27;,</span><br><span class="line">    content_path=&#x27;/api/path&#x27;,</span><br><span class="line">    environment=&#x27;produment&#x27;</span><br><span class="line">&#125; =&gt;</span><br><span class="line">[value1@timestamp1,value2@timestamp2...]</span><br><span class="line"></span><br><span class="line">http_request_status&#123; # 指标名称</span><br><span class="line">    code=&#x27;200&#x27;, # 维度的标签</span><br><span class="line">    content_path=&#x27;/api/path2&#x27;,</span><br><span class="line">    environment=&#x27;produment&#x27;</span><br><span class="line">&#125; =&gt;</span><br><span class="line">[value1@timestamp1,value2@timestamp2...] # 存储的样本值</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>每一条时间序列由指标名称（Metrics Name）以及一组标签（Labels）唯一标识。每条时间序列按照时间的先后顺序存储一系列的样本值。</p>
<ul>
<li><code>http_request_status</code>：指标名称（Metrics Name）</li>
<li><code>&#123;code='200',content_path='/api/path',environment='produment'&#125;</code>：表示维度的标签，基于这些Labels我们可以方便的对监控数据进行聚合，过滤，裁剪</li>
<li><code>[value1@timestamp1,value2@timestamp2...]</code>：按照时间的先后顺序，存储的样本值</li>
</ul>
<h4 id="强大的查询语言PromQL">强大的查询语言PromQL</h4>
<p>Prometheus内置了一个强大的<strong>数据查询语言PromQL</strong>。<strong>通过PromQL可以实现对监控数据的查询、聚合</strong>。同时PromQL也被应用于数据可视化(如Grafana)以及告警当中。</p>
<p>通过PromQL可以轻松回答类似于以下问题：</p>
<ul>
<li>在过去一段时间中95%应用延迟时间的分布范围？</li>
<li>预测在4小时后，磁盘空间占用大致会是什么情况？</li>
<li>CPU占用率前5位的服务有哪些？（过滤）</li>
</ul>
<h4 id="高效">高效</h4>
<p>对于监控系统而言，大量的监控任务必然导致有大量的数据产生。而Prometheus可以高效地处理这些数据，对于单一Prometheus Server实例而言它可以处理：</p>
<ul>
<li><strong>数以百万的监控指标</strong></li>
<li><strong>每秒处理数十万的数据点</strong></li>
</ul>
<h4 id="可扩展">可扩展</h4>
<p>可以在每个数据中心、每个团队运行独立的Prometheus Sevrer。<strong>Prometheus对于联邦集群的支持，可以让多个Prometheus实例产生一个逻辑集群</strong>，当单实例Prometheus Server处理的任务量过大时，<strong>通过使用功能分区（sharding）+联邦集群（federation）可以对其进行扩展</strong>。</p>
<h4 id="易于集成">易于集成</h4>
<ul>
<li>
<p>使用Prometheus可以快速搭建监控服务，并且<strong>可以非常方便地在应用程序中进行集成</strong>。目前支持：<code>Java</code>，<code>JMX</code>，<code>Python</code>，<code>Go</code>，<code>Ruby</code>，<code>.Net</code>，<code>Node.js</code> 等等语言的客户端SDK，基于这些SDK可以快速让应用程序纳入到Prometheus的监控当中，或者开发自己的监控数据收集程序。</p>
</li>
<li>
<p>同时<strong>这些客户端收集的监控数据，不仅仅支持Prometheus，还能支持Graphite这些其他的监控工具</strong>。</p>
</li>
<li>
<p>同时<strong>Prometheus还支持与其他的监控系统进行集成</strong>：Graphite,Statsd,Collected,Scollector,muini,Nagios等。<strong>Prometheus社区还提供了大量第三方实现的监控数据采集支持</strong>：JMX, CloudWatch, EC2, MySQL, PostgresSQL, Haskell, Bash, SNMP, Consul, Haproxy, Mesos, Bind, CouchDB, Django, Memcached, RabbitMQ, Redis, RethinkDB, Rsyslog 等等。</p>
</li>
</ul>
<h4 id="可视化">可视化</h4>
<ul>
<li>Prometheus Server中自带的Prometheus UI，可以方便地直接对数据进行查询，并且支持直接以图形化的形式展示数据。同时Prometheus还提供了一个独立的基于Ruby On Rails的Dashboard解决方案Promdash。</li>
<li>最新的Grafana可视化工具也已经提供了完整的Prometheus支持，基于Grafana可以创建更加精美的监控图标。</li>
<li>基于Prometheus提供的API 还可以实现自己的监控可视化UI。</li>
</ul>
<h4 id="开放性">开放性</h4>
<p>通常来说当我们需要监控一个应用程序时，一般需要该应用程序提供对相应监控系统协议的支持，因此应用程序会与所选择的监控系统进行绑定。为了减少这种绑定所带来的限制，对于决策者而言要么你就直接在应用中集成该监控系统的支持，要么就在外部创建单独的服务来适配不同的监控系统。</p>
<p>而对于Prometheus来说，<strong>使用Prometheus的client library的输出格式不止支持Prometheus的格式化数据，也可以输出支持其它监控系统的格式化数据</strong>，比如Graphite。因此你甚至可以在不使用Prometheus的情况下，采用Prometheus的client library来让你的应用程序支持监控数据采集。</p>
<h3 id="Prometheus架构">Prometheus架构</h3>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030797.png" alt="image-20230426154733485"></p>
<h4 id="Prometheus生态圈组件">Prometheus生态圈组件</h4>
<ul>
<li><code>Prometheus Server</code>：主服务器，负责收集和存储时间序列数据</li>
<li><code>client libraies</code>：应用程序代码插桩，将监控指标嵌入到被监控应用程序中</li>
<li><code>Pushgateway</code>：推送网关，为支持short-lived作业提供一个推送网关</li>
<li><code>exporter</code>：专门为一些应用开发的数据摄取组件一exporter，例如：HAProxy、StatsD、Graphite等等。</li>
<li><code>Alertmanager</code>：专门用于处理alert的组件</li>
</ul>
<h4 id="架构理解">架构理解</h4>
<p>Prometheus既然设计为一个维度存储模型，可以把它理解为一个OLAP系统。</p>
<ol>
<li><strong>存储计算层</strong></li>
</ol>
<ul>
<li>Prometheus Server，里面包含了存储引擎和计算引擎。</li>
<li>Retrieval组件为取数组件，它会主动从Pushgateway或者Exporter拉取指标数据。</li>
<li>Service discovery，可以动态发现要监控的目标。</li>
<li>TSDB，数据核心存储与查询。</li>
<li>HTTP server，对外提供HTTP服务。</li>
</ul>
<ol start="2">
<li><strong>采集层</strong></li>
</ol>
<p>采集层分为两类，一类是生命周期较短的作业，还有一类是生命周期较长的作业。</p>
<ul>
<li>短作业：直接通过API，在退出时将指标推送给Pushgateway</li>
<li>长作业：Retrieval组件直接从Job或者Exporter拉取数据。</li>
</ul>
<ol start="3">
<li><strong>应用层</strong></li>
</ol>
<p>应用层主要分为两种，一种是AlertManager，另一种是数据可视化。</p>
<ul>
<li>
<p>AlertManager</p>
<p>Prometheus本身有一套告警系统，它对接Pagerduty，是一套付费的监控报警系统。可实现短信报警、5分钟无人ack打电话通知、仍然无人ack，通知值班人员Manager.…Emial，发送邮件…</p>
</li>
<li>
<p>数据可视化</p>
<ul>
<li>Prometheus build-in WebUl</li>
<li>Grafana</li>
<li>其他基于API开发的客户端</li>
</ul>
</li>
</ul>
<h2 id="Prometheus及其组件的安装">Prometheus及其组件的安装</h2>
<p>下载地址：<a target="_blank" rel="noopener" href="https://prometheus.io/download/">https://prometheus.io/download/</a></p>
<p>在官网中提供了很多组件供下载：</p>
<ul>
<li>prometheus：核心主服务</li>
<li>alertmanager：告警系统</li>
<li>blackbox_exporter</li>
<li>consul_exporter</li>
<li>graphite_exporter</li>
<li>memcached_exporter</li>
<li>mysqld_exporter</li>
<li>node_exporter</li>
<li>promlens</li>
<li>pushgateway</li>
<li>statsd_exporter</li>
<li>以及一些第三方组件…</li>
</ul>
<hr/>
<p>在本文，主要下载并安装<code>prometheus</code>、<code>node_exporter</code>、<code>pushgateway</code>、<code>alertmanager</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/releases/download/v2.43.0/prometheus-2.43.0.linux-amd64.tar.gz">prometheus-2.43.0.linux-amd64.tar.gz</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter/releases/download/v1.5.0/node_exporter-1.5.0.linux-amd64.tar.gz">node_exporter-1.5.0.linux-amd64.tar.gz</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/pushgateway/releases/download/v1.5.1/pushgateway-1.5.1.linux-amd64.tar.gz">pushgateway-1.5.1.linux-amd64.tar.gz</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz">alertmanager-0.25.0.linux-amd64.tar.gz</a></li>
</ul>
<hr/>
<p>安装环境：</p>
<table>
<thead>
<tr>
<th>虚拟机的hostname</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>centos_02</td>
<td>192.168.179.131</td>
</tr>
<tr>
<td>centos_03</td>
<td>192.168.179.132</td>
</tr>
<tr>
<td>centos_04</td>
<td>192.168.179.133</td>
</tr>
</tbody>
</table>
<p>其中：将prometheus主服务、pushgateway与alertmanager组件只安装于centos_02中。</p>
<h3 id="安装Prometheus">安装Prometheus</h3>
<p>Prometheus基于Golang编写，编译后的软件包，不依赖于任何的第三方依赖。只需要下载对应平台的二进制包，解压并且添加基本的配置即可正常启动Prometheus Server。</p>
<ol>
<li>在虚拟机的<code>/opt/software</code>目录中下载安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.43.0/prometheus-2.43.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压安装包，将其解压到<code>/opt/module</code>目录下；并修改目录名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf prometheus-2.43.0.linux-amd64.tar.gz -C /opt/module</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在/opt/module目录下，修改目录名</span></span><br><span class="line">mv prometheus-2.43.0.linux-amd64 prometheus-2.43.0</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改配置文件<code>prometheus.yml</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos_02 prometheus-2.43.0]# vim prometheus.yml</span><br></pre></td></tr></table></figure>
<p>默认配置如下：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030798.png" alt="image-20230426191631454"></p>
<p>​		在该配置文件中的<code>scrape_configs</code>配置项下添加如下配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Here it<span class="string">&#x27;s Prometheus itself.</span></span></span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="string">The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span></span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#x27;/metrics&#x27;</span><br><span class="line">    # scheme defaults to &#x27;http&#x27;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;centos_02:9090&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="string">添加 pushgateway 监控配置</span></span></span><br><span class="line">  - job_name: &quot;pushgateway&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#x27;centos_02:9091&#x27;]</span><br><span class="line">      labels:</span><br><span class="line">        instance: pushgateway</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="string">添加 Node Exporter 监控配置</span></span></span><br><span class="line">  - job_name: &#x27;node exporter&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#x27;centos_02:9100&#x27;, &#x27;centos_03:9100&#x27;, &#x27;centos_04:9100&#x27;]</span><br></pre></td></tr></table></figure>
<p>配置说明：</p>
<ol>
<li><strong>global配置块</strong>：控制Prometheus服务器的全局配置
<ul>
<li><code>scrape_interval</code>：配置拉取数据的时间间隔，默认为1分钟</li>
<li><code>evaluation_interval</code>：规则验证（生产alert）的时间间隔，默认1分钟</li>
</ul>
</li>
<li><strong>rule_files配置块</strong>：规则配置文件</li>
<li><strong>scrape_configs配置块</strong>：配置采集目标相关，prometheus监视的目标。Prometheus自身的运行信息可以通过HTTP访问，所以Prometheus可以监控自己的运行数据。
<ul>
<li><code>job_name</code>：监控作业的名称</li>
<li><code>static_configs</code>：表示静态目标配置，就是固定从某个target拉取数据</li>
<li><code>targets</code>：指定监控的目标，即从哪拉取数据。Prometheus会从<code>http://centos_02:9090/metrics</code>上拉取数据。</li>
</ul>
</li>
</ol>
<p>Prometheus是<strong>可以在运行时自动加载配置</strong>的。启动时需要添加：<code>--web.enable-lifecycle</code></p>
<h3 id="安装pushgateway">安装pushgateway</h3>
<p>Prometheus在正常情况下是采用拉模式从产生metric的作业或者exporter(比如专门监控主机的NodeExporter)拉取监控数据。但是我们若要监控的是Flink on YARN作业，想要让Prometheus自动发现作业的提交、结束以及自动拉取数据显然是比较困难的。PushGateway就是一个中转组件，通过配置Flink on YARN作业将metric推到PushGateway，Prometheus再从PushGateway拉取就可以了。</p>
<hr/>
<ol>
<li>在虚拟机的<code>/opt/software</code>目录中下载安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.5.1/pushgateway-1.5.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压安装包，将其解压到<code>/opt/module</code>目录下；并修改目录名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf pushgateway-1.5.1.linux-amd64.tar.gz -C /opt/module/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在/opt/module目录下，修改目录名</span></span><br><span class="line">mv pushgateway-1.5.1.linux-amd64 pushgateway-1.5.1</span><br></pre></td></tr></table></figure>
<h3 id="安装Alertmanager（选择性安装）">安装Alertmanager（选择性安装）</h3>
<ol>
<li>在虚拟机的<code>/opt/software</code>目录中下载安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压安装包，将其解压到<code>/opt/module</code>目录下；并修改目录名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf alertmanager-0.25.0.linux-amd64.tar.gz -C /opt/module</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在/opt/module目录下，修改目录名</span></span><br><span class="line">mv alertmanager-0.25.0.linux-amd64 alertmanager-0.25.0</span><br></pre></td></tr></table></figure>
<p>默认配置文件<code>alertmanager.yml</code>如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1h</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;web.hook&#x27;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;web.hook&#x27;</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://127.0.0.1:5001/&#x27;</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="安装Node-Exporter（选择性安装）">安装Node Exporter（选择性安装）</h3>
<p>在Prometheus的架构设计中，Prometheus Server主要负责数据的收集，存储并且对外提供数据查询支持，而实际的监控样本数据的收集则是由Exporter完成。因此为了能够监控到某些东西，如主机的CPU使用率，我们需要使用到Exporter。Prometheus周期性的从Exporter暴露的HTTP服务地址(通常是/metrics)拉取监控样本数据。</p>
<p>Exporter可以是一个相对开放的概念，其可以是一个独立运行的程序独立于监控目标以外，也可以是直接内置在监控目标中。只要能够向Prometheus提供标准格式的监控样本数据即可。</p>
<p><strong>为了能够采集到主机的运行指标如CPU,内存，磁盘等信息。我们可以使用Node Exporter</strong>。Node Exporter同样采用Golang编写，并且不存在任何的第三方依赖，只需要下载，解压即可运行。</p>
<hr/>
<ol>
<li>在虚拟机的<code>/opt/software</code>目录中下载安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.5.0/node_exporter-1.5.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压安装包，将其解压到<code>/opt/module</code>目录下；并修改目录名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf node_exporter-1.5.0.linux-amd64.tar.gz -C /opt/module</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在/opt/module目录下，修改目录名</span></span><br><span class="line">mv node_exporter-1.5.0.linux-amd64 node_exporter-1.5.0</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动并通过页面查看是否成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动node_exporter</span></span><br><span class="line">./node_exporter</span><br></pre></td></tr></table></figure>
<p>​			在浏览器中输入：<code>http://192.168.179.131:9100/metrics</code>，可以看到当前 node exporter 获得到的centos_02上的所有监控数据。</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030799.png" alt="image-20230426202453789"></p>
<h3 id="监控多节点">监控多节点</h3>
<p>根据上述安装步骤，将<code>node_exporter</code>安装到centos_02、centos_03、centos_04中</p>
<p>后台运行node_exporter的命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos_02 node_exporter-1.5.0]# nohup ./node_exporter --web.listen-address=:9100 &amp;</span><br></pre></td></tr></table></figure>
<p>其中9100为端口号，也可以自定义。</p>
<hr/>
<p>若要用prometheus拉取监控的数据，则在prometheus.yml中需配置对应的目标。之前在安装Prometheus时已经配置过了，如下：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030800.png" alt="image-20230426204534822"></p>
<hr/>
<h3 id="设置node-exporter为开机自启">设置node_exporter为开机自启</h3>
<p>网上应该有多种方法。这里只写一种。</p>
<ol>
<li><strong>创建service文件</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先创建文件</span></span><br><span class="line">sudo vim /usr/lib/systemd/system/node_exporter.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入以下内容</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=node_export</span><br><span class="line">Documentation=https://github.com/prometheus/node_exporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/module/node_exporter-1.5.0/node_exporter --web.listen-address=0.0.0.0:9100</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>设置为开机自启动。（注：当前目录需在与<code>node_exporter.service</code>同级目录下）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos_02 system]# systemctl enable node_exporter.service</span><br></pre></td></tr></table></figure>
<p>通过上述设置，可以将node_exporter设置为一个服务，通过以下命令可以进行服务管理：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">systemctl start node_exporter.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止</span></span><br><span class="line">systemctl stop node_exporter.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">systemctl restart node_exporter.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务状态</span></span><br><span class="line">systemctl status node_exporter.service</span><br></pre></td></tr></table></figure>
<h3 id="启动Prometheus-Server、Pushgateway和Alertmanager">启动Prometheus Server、Pushgateway和Alertmanager</h3>
<h4 id="启动Prometheus-Server">启动Prometheus Server</h4>
<ol>
<li><strong>启动Prometheus</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/module/prometheus-2.43.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">nohup ./prometheus --config.file=prometheus.yml &gt; ./prometheus.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否启动</span></span><br><span class="line">ps -ef | grep prometheus</span><br></pre></td></tr></table></figure>
<p>启动成功：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030801.png" alt="image-20230427101533663"></p>
<p>也可以在浏览器中输入<code>http://192.168.179.131:9090/</code>，打开界面：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030802.png" alt="image-20230427105819321"></p>
<p>进入如下界面：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030803.png" alt="image-20230427110457572"></p>
<blockquote>
<p>若node exporter显示down状态，</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030804.png" alt="image-20230427110530764"></p>
<p>则可以在浏览器所在的电脑上找到<code>hosts</code>文件，<strong>将对应虚拟机的IP地址和hostname做好映射</strong>，如下：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030805.png" alt="image-20230427110725839"></p>
</blockquote>
<h4 id="启动pushgateway">启动pushgateway</h4>
<p>在centos_02中：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/module/pushgateway-1.5.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">nohup ./pushgateway --web.listen-address :9091 &gt; ./pushgateway.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再次从浏览器中输入<code>http://centos_02:9090/</code>去查看Prometheus的targets界面：</p>
<img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030806.png" alt="image-20230427135931492" style="zoom:67%;" />
<h4 id="启动alertmanager">启动alertmanager</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/module/alertmanager-0.25.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">nohup ./alertmanager --config.file=alertmanager.yml &gt; ./alertmanager.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<h3 id="时间不同步导致的问题">时间不同步导致的问题</h3>
<p>若浏览器所在系统的时间与prometheus服务器的时间 <strong>不同步</strong>，则访问<code>http://centos_02:9090/</code>时会出现如下警告：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030808.png" alt="image-20230427152544217"></p>
<p><strong>解决方法</strong>：</p>
<ol>
<li>在服务器中执行如下命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030809.png" alt="image-20230427152651449"></p>
<p>就能查到数据了。</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030810.png" alt="image-20230427152729649"></p>
<p>若此处警告消失，但还是无法显示数据，则在prometheus服务器中做如下步骤：</p>
<ol start="0">
<li>
<p>可以先查询<code>prometheus.log</code>，看看里面哪里报错。</p>
</li>
<li>
<p>kill掉prometheus服务</p>
</li>
<li>
<p>删除<code>prometheus</code>安装目录下的<code>data</code>文件夹</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030811.png" alt="image-20230427152849561"></p>
<ol start="3">
<li>重新启动prometheus</li>
</ol>
<h2 id="PromQL介绍">PromQL介绍</h2>
<p>Prometheus通过指标名称(metrics name)以及对应的一组标签(labelset)唯一定义一条时间序列。指标名称反映了监控样本的基本标识，而label则在这个基本特征上为采集到的数据提供了多种特征维度。用户可以基于这些特征维度<strong>过滤，聚合，统计</strong>从而产生新的计算后的一条时间序列。<strong>PromQL是Prometheus内置的数据查询语言</strong>，其提供对时间序列数据丰富的查询，聚合以及逻辑运算能力的支持。并且被广泛应用在Prometheus的日常应用当中，包括对数据查询、可视化、告警处理当中。可以这么说，PromQL是Prometheus所有应用场景的基础，理解和掌握PromQL是Prometheus入门的第一课。</p>
<h3 id="基本用法">基本用法</h3>
<p>基于上述对prometheus及其组件的安装，本文通过使用prometheus，来简单使用PromQL，不做过多讲解。</p>
<h4 id="查询时间序列">查询时间序列</h4>
<p>当Prometheus通过Exporter采集到相应的监控指标样本数据后，我们就可以通过PromQL对监控样本数据进行查询。</p>
<p>当我们直接使用监控指标名称查询时，可以<strong>查询该指标下的所有时间序列</strong>。如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等同于以下命令</span></span><br><span class="line">prometheus_http_requests_total&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>该表达式会返回指标名称为<code>prometheus_http_requests_total</code>的所有时间序列：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, handler=&quot;/-/ready&quot;, instance=&quot;centos_02:9090&quot;, job=&quot;prometheus&quot;&#125;</span><br><span class="line"></span><br><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, handler=&quot;/api/v1/label/:name/values&quot;, instance=&quot;centos_02:9090&quot;, job=&quot;prometheus&quot;&#125;</span><br><span class="line"></span><br><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, handler=&quot;/api/v1/metadata&quot;, instance=&quot;centos_02:9090&quot;, job=&quot;prometheus&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>上述指标是将所有和prometheus http相关的请求都统计出来，统计请求次数</p>
<p>查询界面如下：</p>
<img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030812.png" alt="image-20230427160807392" style="zoom: 67%;" />
<p>PromQL还<strong>支持用户根据时间序列的标签匹配模式来对时间序列进行过滤</strong>，目前主要支持两种匹配模式：<strong>完全匹配</strong>和<strong>正则匹配</strong>。</p>
<ul>
<li><strong>PromQL支持使用<code>=</code>和<code>!=</code>两种完全匹配模式</strong>：
<ul>
<li>通过使用<code>label=value</code>可以选择那些标签满足表达式定义的时间序列；</li>
<li>反之使用<code>label!=value</code>则可以根据标签匹配排除时间序列；</li>
</ul>
</li>
</ul>
<p>例如，如果我们只需要查询所有<code>prometheus_http requests_total</code>时间序列中满足标签<code>instance</code>为<code>localhost::9090</code>的时间序列，则可以使用如下表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;instance=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>反之，使用<code>instance!=&quot;localhost:9090&quot;</code>则可以排除这些时i间序列：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;instance!=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PromQL还可以支持使用正则表达式作为匹配条件，多个表达式之间使用<code>|</code>进行分离：
<ul>
<li>使用<code>label=~regx</code>表示选择那些标签符合正则表达式定义的时间序列；</li>
<li>反之，使用<code>label!~regx</code>进行排除；</li>
</ul>
</li>
</ul>
<p>例如，如果想查询多个环境下的时间序列序列可以使用如下表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;environment=~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>排除用法：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;environment!~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="范围查询">范围查询</h4>
<p>直接通过类似于PromQL表达式<code>prometheus_http_requests_total</code>查询时间序列时，<strong>返回值中只会包含该时间序列中的最新的一个样本值</strong>，这样的返回结果我们称之为<strong>瞬时向量</strong>。而相应的这样的表达式称之为<strong>瞬时向量表达式</strong>。</p>
<p>而如果我们<strong>想过去一段时间范围内的样本数据</strong>时，我们则需要使用<strong>区间向量表达式</strong>。<strong>区间向量表达式和瞬时向量表达式之间的差异在于在区间向量表达式中我们需要定义时间选择的范围，时间范围通过时间范围选择器进行定义</strong>。</p>
<p>例如，通过以下表达式可以选择最近5分钟内的所有样本数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;&#125;[5m]</span><br></pre></td></tr></table></figure>
<p>该表达式将会返回查询到的时间序列中最近5分钟的所有样本数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total&#123;code=&quot;200&quot;, handler=&quot;/metrics&quot;, instance=&quot;centos_02:9090&quot;, job=&quot;prometheus&quot;&#125;=[</span><br><span class="line">231 @1682583567.916</span><br><span class="line">232 @1682583582.929</span><br><span class="line">233 @1682583597.916</span><br><span class="line">234 @1682583612.916</span><br><span class="line">235 @1682583627.923</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030813.png" alt="image-20230427162217915" style="zoom:50%;" />
<p>通过区间向量表达式查询到的结果我们称为<strong>区间向量</strong>。</p>
<p>除了使用表示分钟以外，PromQL的时间范围选择器支持其它时间单位：</p>
<ul>
<li><code>s</code>：秒</li>
<li><code>m</code>：分钟</li>
<li><code>h</code>：小时</li>
<li><code>d</code>：天</li>
<li><code>w</code>：周</li>
<li><code>y</code>：年</li>
</ul>
<h4 id="时间位移操作">时间位移操作</h4>
<p><strong>在瞬时向量表达式或者区间向量表达式中，都是以当前时间为基准</strong>：</p>
<ul>
<li><code>prometheus_http_requests total&#123;&#125;</code>：瞬时向量表达式，选择当前最新的数据</li>
<li><code>prometheus_http_requests total&#123;&#125;[5m]</code>：区间向量表达式，选择以当前时间为基准，5分钟内的数据</li>
</ul>
<p>而如果我们想查询，5分钟前的瞬时样本数据，或昨天一天的区间内的样本数据呢？这个时候我们就可以使用位移操作，<strong>位移操作的关键字为<code>offset</code></strong>。可以使用<code>offset</code>时间位移操作：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询5分钟前的瞬时向量</span></span><br><span class="line">prometheus_http_requests_total&#123;&#125; offset 5m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询昨天一天的区间向量</span></span><br><span class="line">prometheus_http_requests_total&#123;&#125;[1d] offset 1d</span><br></pre></td></tr></table></figure>
<h4 id="使用聚合操作">使用聚合操作</h4>
<p>一般来说，如果描述样本特征的标签（label）在并非唯一的情况下，通过PromQL查询数据，会返回多条满足这些特征维度的时间序列。而<strong>PromQL提供的聚合操作可以用来对这些时间序列进行处理，形成一条新的时间序列</strong>：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询所有http请求的总数量</span></span><br><span class="line">sum(prometheus_http_requests_total)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">按照mode计算主机CPU的平均使用时间</span></span><br><span class="line">avg(node_cpu_seconds_total) by (mode)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">按照主机查询各个主机的CPU使用率</span></span><br><span class="line">sum(sum(irate(node_cpu_seconds_total&#123;mode!=&#x27;idle&#x27;&#125;[5m])) / sum(irate(node_cpu_seconds_total[5m]))) by (instance)</span><br></pre></td></tr></table></figure>
<h4 id="标量和字符串">标量和字符串</h4>
<p>除了使用瞬时向量表达式和区间向量表达式以外，PromQL还直接支持用户使用标量（Scalar）和字符串（String）。</p>
<ul>
<li><strong>标量(Scalar)：一个浮点型的数字值</strong></li>
</ul>
<p>标量只有一个数字，没有时序。例如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">10</span><br></pre></td></tr></table></figure>
<p>需要注意的是，当使用表达式<code>count(prometheus_http_requests_total)</code>，返回的数据类型，依然是瞬时向量。用户可以通过内置函数<code>scalar()</code>将单个瞬时向量转换为标量。</p>
<ul>
<li><strong>字符串（String）：一个简单的字符串值</strong></li>
</ul>
<p>直接使用字符串，作为PromQL表达式，则会直接返回字符串。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&quot;this is a string&quot;</span><br><span class="line">&#x27;these are unescaped: \n \\ \t&#x27;</span><br><span class="line">`these are not unescaped: \n &#x27; &quot; \t`</span><br></pre></td></tr></table></figure>
<p>从中可以看出，字符串中可以使用转义字符<code>\</code></p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030814.png" alt="image-20230427170818280"></p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030815.png" alt="image-20230427170754215"></p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030816.png" alt="image-20230427170840030"></p>
<h4 id="合法的PromQL表达式">合法的PromQL表达式</h4>
<p>所有的PromQL表达式都<strong>必须至少包含一个指标名称</strong>（例如<code>http_request_total</code>），或者一个<strong>不会匹配到空字符串</strong>的标签过滤器（例如<code>&#123;code=&quot;200&quot;&#125;</code>）。</p>
<p>因此以下两种方式，均为合法的表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total		# 合法</span><br><span class="line">prometheus_http_requests_total&#123;&#125;	# 合法</span><br><span class="line">&#123;method=&quot;get&quot;&#125;					# 合法</span><br></pre></td></tr></table></figure>
<p>而如下表达式，则不合法：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;job=~&quot;.*&quot;&#125;		# 不合法</span><br></pre></td></tr></table></figure>
<p>同时，除了使用<code>&#123;label=value&#125;</code>的形式以外，我们还可以使用内置的<code>__name__</code>标签来指定监控指标名称：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;__name__=~&quot;prometheus_http_requests_total&quot;&#125;	# 合法</span><br><span class="line">&#123;__name__=~&quot;node_disk_written_bytes_total|node_disk_read_bytes_total&quot;&#125;		# 合法</span><br></pre></td></tr></table></figure>
<h3 id="PromQL操作符">PromQL操作符</h3>
<p>使用PromQL除了能够方便的按照查询和过滤时间序列以外，PromQL<strong>还支持丰富的操作符</strong>，用户可以使用这些操作符对进一步的对事件序列进行二次加工。这些操作符包括：<strong>数学运算符</strong>，<strong>逻辑运算符</strong>，<strong>布尔运算符</strong>等等。</p>
<h4 id="数学运算">数学运算</h4>
<ul>
<li><code>+</code>：加法</li>
<li><code>-</code>：减法</li>
<li><code>*</code>：乘法</li>
<li><code>/</code>：除法</li>
<li><code>%</code>：求余</li>
<li><code>^</code>：幂运算</li>
</ul>
<h4 id="布尔运算">布尔运算</h4>
<ul>
<li>
<p>Prometheus支持以下布尔运算如下：</p>
<ul>
<li><code>==</code>：相等</li>
<li><code>!-</code>：不相等</li>
<li><code>&gt;</code>：大于</li>
<li><code>&lt;</code>：小于</li>
<li><code>&gt;=</code>：大于等于</li>
<li><code>&lt;=</code>：小于等于</li>
</ul>
</li>
<li>
<p>使用bool修饰符改变布尔运算符的行为</p>
</li>
</ul>
<p><strong>布尔运算符的默认行为是对时序数据进行过滤</strong>。而<strong>在其它的情况下我们可能需要的是真正的布尔结果</strong>。例如，只需要知道当前模块的HTTP请求量是否&gt;=1000，如果大于等于1000则返回1(true)否则返回0(false)。这时可以使用bool修饰符改变布尔运算的默认行为。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">prometheus_http_requests_total &gt; bool 1000</span><br></pre></td></tr></table></figure>
<p>使用bool修改符后，布尔运算不会对时间序列进行过滤，而是直接依次瞬时向量中的各个样本数据与标量的比较结果0或者1。从而形成一条新的时间序列。</p>
<img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030817.png" alt="image-20230427194249002" style="zoom:80%;" />
<p>同时需要注意的是，如果是在两个标量之间使用布尔运算，则必须使用bool修饰符：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2 == bool 2		# 结果为1</span><br></pre></td></tr></table></figure>
<h4 id="使用集合运算符">使用集合运算符</h4>
<p>使用瞬时向量表达式能够获取到一个包含多个时间序列的集合，我们称为<strong>瞬时向量</strong>。通过集合运算，<strong>可以在两个瞬时向量与瞬时向量之间进行相应的集合操作</strong>。</p>
<p>目前，Prometheus支持以下集合运算符：</p>
<ul>
<li><code>and</code>：并且</li>
<li><code>or</code>：或者</li>
<li><code>unless</code>：排除</li>
</ul>
<p>vector1 and vector2：会产生一个由vector1的元素组成的新的向量。<strong>该向量包含vector1中完全匹配vector2中的元素组成</strong>。（相当于 与门）</p>
<p>vector1 or vector2：会产生一个新的向量，<strong>该向量包含vector1中所有的样本数据以及vector2中没有与vector1匹配到的样本数据</strong>。（相当于 或门）</p>
<p>vector1 unless vector2：会产生一个新的向量，新向量中的元素由vector1中没有与vector2匹配的元素组成。</p>
<h4 id="操作符优先级">操作符优先级</h4>
<p>对于复杂类型的表达式，需要了解运算操作的运行优先级。例如，查询主机的CPU使用率，可以使用表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">100 * (1 - avg(irate(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[5m])) by(job))</span><br></pre></td></tr></table></figure>
<p>其中**<code>irate</code>是PromQL中的内置函数，用于计算区间向量中时间序列每秒的即时增长率**。</p>
<p>在PromQL操作符中优先级由高到低依次为：</p>
<ul>
<li><code>^</code></li>
<li><code>*</code>，<code>/</code>，<code>%</code></li>
<li><code>+</code>，<code>-</code></li>
<li><code>==</code>，<code>!=</code>，<code>&lt;=</code>，<code>=</code>，<code>&gt;</code>，…</li>
<li><code>and</code>，<code>unless</code></li>
<li><code>or</code></li>
</ul>
<h4 id="PromQL聚合操作">PromQL聚合操作</h4>
<p>Prometheus还提供了下列内置的<strong>聚合操作符</strong>，这些操作符作用域瞬时向量。<strong>可以将瞬时表达式返回的样本数据进行聚合，形成一个新的时间序列</strong>。</p>
<ul>
<li><code>sum</code>：求和</li>
<li><code>min</code>：最小值</li>
<li><code>max</code>：最大值</li>
<li><code>avg</code>：平均值</li>
<li><code>stddev</code>：标准差</li>
<li><code>stdvar</code>：标准差异</li>
<li><code>count</code>：计数</li>
<li><code>count_values</code>：对value进行计数</li>
<li><code>bottomk</code>：后n条时序</li>
<li><code>topk</code>：前n条时序</li>
<li><code>quantile</code>：分布统计</li>
</ul>
<p>使用聚合操作的语法如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure>
<p>其中只有<code>count_values</code>，<code>quantile</code>，<code>topk</code>，<code>bottomk</code>支持参数（parameter）。</p>
<p>without用于从计算结果中移除列举的标签，而保留其它标签。</p>
<p>by则正好相反，结果向量中只保留列出的标签，其余标签则移除。通过without和by可以按照样本的问题对数据进行聚合。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sum(prometheus_http_requests_total) without (instance)</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sum(prometheus_http_requests_total) by (code,handler,job,method)</span><br></pre></td></tr></table></figure>
<p>如果只需要计算整个应用的HTTP请求总量，可以直接使用表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sum(prometheus_http_requests_total)</span><br></pre></td></tr></table></figure>
<p><code>count_values</code>用于时间序列中每一个样本值出现的次数。<code>count_values</code>会为每一个唯一的样本值输出一个时间序列，并且每一个时间序列包含一个额外的标签。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">count_values(&quot;count&quot;, prometheus_http_requests_total)</span><br></pre></td></tr></table></figure>
<p><code>topk</code>和<code>bottomk</code>则用于对样本值进行排序，返回当前样本值前n位，或者后n位的时间序列。</p>
<p>获取HTTP请求数前5位的时序样本数据，可以使用表达式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">topk(5, prometheus_http_requests_total)</span><br></pre></td></tr></table></figure>
<p><code>quantile</code>用于计算当前样本数据值的分布情况<code>quantile(p, express))</code>，其中0≤p≤1。</p>
<p>例如，当p为0.5时，即表示找到当前样本数据中的中位数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">quantile(0.5, prometheus_http_requests_total)</span><br></pre></td></tr></table></figure>
<h2 id="Prometheus-和-Grafana-集成">Prometheus 和 Grafana 集成</h2>
<p>grafana是一款采用Go语言编写的开源应用，主要用于大规模指标数据的可视化展现，是网络架构和应用分析中最流行的时序数据展示工具，目前已经支持绝大部分常用的时序数据库。</p>
<p>grafana官网：<a target="_blank" rel="noopener" href="https://grafana.com/">https://grafana.com/</a></p>
<p>grafana下载地址：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1">https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1</a></p>
<h3 id="下载安装Grafana">下载安装Grafana</h3>
<ol>
<li>下载Grafana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos_02 software]# wget https://dl.grafana.com/enterprise/release/grafana-enterprise-9.5.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>解压到指定目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos_02 software]# tar -zxvf grafana-enterprise-9.5.1.linux-amd64.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>
<h3 id="启动Grafana">启动Grafana</h3>
<ol>
<li>后台启动Grafana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/module/grafana-9.5.1</span><br><span class="line"></span><br><span class="line">nohup ./bin/grafana-server web &gt; ./grafana.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>检查是否启动成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef | grep grafana</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>打开浏览器，访问<code>http://centos_02:3000/</code>。默认用户和密码为：<code>admin</code></li>
</ol>
<p>展示页面如下：</p>
<img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030818.png" alt="image-20230502161137192" style="zoom: 80%;" />
<h3 id="添加数据源-Prometheus">添加数据源 Prometheus</h3>
<ol>
<li>点击<code>Your connections</code>按钮</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030819.png" alt="image-20230502161450170"></p>
<ol start="2">
<li>点击添加数据源</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030820.png" alt="image-20230502161529669"></p>
<ol start="3">
<li>选择 Prometheus</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030821.png" alt="image-20230502161623622"></p>
<ol start="4">
<li>配置Prometheus Server地址</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030822.png" alt="image-20230502161807017"></p>
<p>并点击下方的 Save&amp;test</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030823.png" alt="image-20230502161845617"></p>
<p>若出现以下界面，则说明已成功获取数据源。</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030824.png" alt="image-20230502161933365"></p>
<blockquote>
<p>注：在获取数据源之前，要保证数据源在正常工作。</p>
</blockquote>
<h3 id="手动创建仪表盘Dashboard">手动创建仪表盘Dashboard</h3>
<ol>
<li>点击<code>Dashboard</code></li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030825.png" alt="image-20230502162302600"></p>
<ol start="2">
<li>创建Dashboard</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030826.png" alt="image-20230502162355790"></p>
<ol start="3">
<li>点击添加</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030827.png" alt="image-20230502162501755"></p>
<ol start="4">
<li>查询具体某个指标的配置如下：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030828.png" alt="image-20230502162923146"></p>
<blockquote>
<p>注：也可以导入其他人的仪表盘，直接使用别人的模板</p>
</blockquote>
<h3 id="Grafana官方的Dashboard模板">Grafana官方的Dashboard模板</h3>
<p>官方模板：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/?plcmt=footer">https://grafana.com/grafana/dashboards/?plcmt=footer</a></p>
<p>界面如下：</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030829.png" alt="image-20230502182751067"></p>
<p>点击某个具体的模板，从中可以看到，可以通过ID或者下载其JSON文件来获得这个Dashboard!</p>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030830.png" alt="image-20230502183145611"></p>
<hr/>
<p>导入模板演示：</p>
<ol>
<li>浏览器访问<code>http://centos_02:3000/dashboards</code>，进入Grafana服务器的Dashboards中。点击Import按钮</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030831.png" alt="image-20230502183537471"></p>
<ol start="2">
<li>主要有两种导入方式，如下：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030832.png" alt="image-20230502183615607"></p>
<ol start="3">
<li>此处选择直接导入Grafana官网推荐的模板的ID</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030833.png" alt="image-20230502183711459"></p>
<ol start="4">
<li>选择模板需要的数据源</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030834.png" alt="image-20230502183739373"></p>
<ol start="5">
<li>导入成功后可以看到相应的dashboard</li>
</ol>
<p><img src="https://raw.githubusercontent.com/hugh-98/PicGo/main/img/202305022030835.png" alt="image-20230502183815669"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://hugh-98.github.io">Hugh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hugh-98.github.io/2023/04/25/Prometheus+Grafana/">https://hugh-98.github.io/2023/04/25/Prometheus+Grafana/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hugh-98.github.io" target="_blank">Hugh的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a><a class="post-meta__tags" href="/tags/Grafana/">Grafana</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/27/Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Git常用命令"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git常用命令</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/19/office%E8%BD%AF%E4%BB%B6/" title="office软件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">office软件</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Hugh</div><div class="author-info__description">Life is like a box of chocolates, you never know what you're going to get.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hugh-98"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">若在文章中无法显示图片，则需先用科学上网后才能看到。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Prometheus介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPrometheus"><span class="toc-number">1.1.</span> <span class="toc-text">什么是Prometheus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">特点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%93%E4%BA%8E%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">易于管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%86%85%E9%83%A8%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">监控服务的内部运行状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%A4%A7%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">强大的数据模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%A4%A7%E7%9A%84%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80PromQL"><span class="toc-number">1.2.4.</span> <span class="toc-text">强大的查询语言PromQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E6%95%88"><span class="toc-number">1.2.5.</span> <span class="toc-text">高效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%B1%95"><span class="toc-number">1.2.6.</span> <span class="toc-text">可扩展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%93%E4%BA%8E%E9%9B%86%E6%88%90"><span class="toc-number">1.2.7.</span> <span class="toc-text">易于集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">1.2.8.</span> <span class="toc-text">可视化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E6%80%A7"><span class="toc-number">1.2.9.</span> <span class="toc-text">开放性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">Prometheus架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus%E7%94%9F%E6%80%81%E5%9C%88%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">Prometheus生态圈组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E7%90%86%E8%A7%A3"><span class="toc-number">1.3.2.</span> <span class="toc-text">架构理解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E5%8F%8A%E5%85%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">Prometheus及其组件的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Prometheus"><span class="toc-number">2.1.</span> <span class="toc-text">安装Prometheus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85pushgateway"><span class="toc-number">2.2.</span> <span class="toc-text">安装pushgateway</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Alertmanager%EF%BC%88%E9%80%89%E6%8B%A9%E6%80%A7%E5%AE%89%E8%A3%85%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">安装Alertmanager（选择性安装）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Node-Exporter%EF%BC%88%E9%80%89%E6%8B%A9%E6%80%A7%E5%AE%89%E8%A3%85%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">安装Node Exporter（选择性安装）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E5%A4%9A%E8%8A%82%E7%82%B9"><span class="toc-number">2.5.</span> <span class="toc-text">监控多节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEnode-exporter%E4%B8%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF"><span class="toc-number">2.6.</span> <span class="toc-text">设置node_exporter为开机自启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Prometheus-Server%E3%80%81Pushgateway%E5%92%8CAlertmanager"><span class="toc-number">2.7.</span> <span class="toc-text">启动Prometheus Server、Pushgateway和Alertmanager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Prometheus-Server"><span class="toc-number">2.7.1.</span> <span class="toc-text">启动Prometheus Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8pushgateway"><span class="toc-number">2.7.2.</span> <span class="toc-text">启动pushgateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8alertmanager"><span class="toc-number">2.7.3.</span> <span class="toc-text">启动alertmanager</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%B8%8D%E5%90%8C%E6%AD%A5%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.8.</span> <span class="toc-text">时间不同步导致的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PromQL%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">PromQL介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">3.1.1.</span> <span class="toc-text">查询时间序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.1.2.</span> <span class="toc-text">范围查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BD%8D%E7%A7%BB%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.3.</span> <span class="toc-text">时间位移操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.4.</span> <span class="toc-text">使用聚合操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E9%87%8F%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.1.5.</span> <span class="toc-text">标量和字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E6%B3%95%E7%9A%84PromQL%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">3.1.6.</span> <span class="toc-text">合法的PromQL表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PromQL%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">3.2.</span> <span class="toc-text">PromQL操作符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97"><span class="toc-number">3.2.1.</span> <span class="toc-text">数学运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E8%BF%90%E7%AE%97"><span class="toc-number">3.2.2.</span> <span class="toc-text">布尔运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%9B%86%E5%90%88%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">3.2.3.</span> <span class="toc-text">使用集合运算符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.2.4.</span> <span class="toc-text">操作符优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PromQL%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.5.</span> <span class="toc-text">PromQL聚合操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-%E5%92%8C-Grafana-%E9%9B%86%E6%88%90"><span class="toc-number">4.</span> <span class="toc-text">Prometheus 和 Grafana 集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85Grafana"><span class="toc-number">4.1.</span> <span class="toc-text">下载安装Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Grafana"><span class="toc-number">4.2.</span> <span class="toc-text">启动Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E6%BA%90-Prometheus"><span class="toc-number">4.3.</span> <span class="toc-text">添加数据源 Prometheus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E4%BB%AA%E8%A1%A8%E7%9B%98Dashboard"><span class="toc-number">4.4.</span> <span class="toc-text">手动创建仪表盘Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana%E5%AE%98%E6%96%B9%E7%9A%84Dashboard%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.5.</span> <span class="toc-text">Grafana官方的Dashboard模板</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/03/Redis/" title="Redis入门">Redis入门</a><time datetime="2023-05-03T02:07:46.000Z" title="发表于 2023-05-03 10:07:46">2023-05-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/27/Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Git常用命令">Git常用命令</a><time datetime="2023-04-27T05:34:04.000Z" title="发表于 2023-04-27 13:34:04">2023-04-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/25/Prometheus+Grafana/" title="Prometheus+Grafana监控入门">Prometheus+Grafana监控入门</a><time datetime="2023-04-25T02:47:23.000Z" title="发表于 2023-04-25 10:47:23">2023-04-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/19/office%E8%BD%AF%E4%BB%B6/" title="office软件">office软件</a><time datetime="2023-04-19T12:46:55.000Z" title="发表于 2023-04-19 20:46:55">2023-04-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/07/Kafka%E9%9B%86%E6%88%90SpringBoot/" title="Kafka集成SpringBoot">Kafka集成SpringBoot</a><time datetime="2023-04-07T03:10:26.000Z" title="发表于 2023-04-07 11:10:26">2023-04-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Hugh</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://hugh-98.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'mOxPmpzRdaSEBRH4FPLh3IOA-gzGzoHsz',
      appKey: 'KXhA9ey1dBoGtsiuDmz48WWk',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>